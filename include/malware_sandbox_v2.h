#ifndef MALWARE_SANDBOX_V2_H
#define MALWARE_SANDBOX_V2_H

#include <iostream>
#include <string>
#include <vector>
#include <cstdint>
#include <unordered_map>
#include <chrono>

namespace Analysis {

struct SandboxReport {
    std::string sample_hash;
    std::string malware_family;
    double confidence_score;
    std::vector<std::string>ttps;
    std::vector<std::string> iocs;
    std::vector<std::string> dropped_files;
    std::vector<std::string> network_connections;
    std::vector<std::string> registry_changes;
    std::vector<std::string> api_calls;
    std::vector<std::string> suspicious_behaviors;
    std::uint64_t execution_time_ms;
    std::string verdict;
};

struct BehaviorTrace {
    std::uint64_t timestamp;
    std::string process_name;
    std::string action;
    std::string target;
    std::string details;
    bool is_suspicious;
};

struct DynamicAnalysis {
    std::string analysis_id;
    std::string sample_path;
    std::uint64_t start_time;
    std::uint64_t end_time;
    std::vector<BehaviorTrace> behavior_log;
    std::vector<std::string> file_operations;
    std::vector<std::string> registry_operations;
    std::vector<std::string> network_requests;
    std::vector<std::string> process_operations;
    bool crash_detected;
    std::string crash_reason;
};

class MalwareSandboxV2 {
public:
    MalwareSandboxV2();
    ~MalwareSandboxV2();
    
    bool initialize();
    SandboxReport analyze_sample(const std::string& sample_path);
    DynamicAnalysis run_dynamic_analysis(const std::string& sample_path, uint32_t timeout_seconds);
    std::vector<BehaviorTrace> get_behavior_trace();
    bool detect_evasion_techniques();
    bool detect_anti_vm();
    bool detect_sandbox_sleep();
    bool detect_timing_attacks();
    void generate_sandbox_report(const SandboxReport& report);
    
private:
    bool initialized_;
    std::vector<BehaviorTrace> behavior_log_;
    
    bool setup_isolation();
    bool inject_sample(const std::string& sample_path);
    bool monitor_behaviors();
    bool collect_artifacts();
    bool cleanup_isolation();
    std::vector<std::string> classify_malware(const DynamicAnalysis& analysis);
};

} // namespace Analysis

#endif // MALWARE_SANDBOX_V2_H
